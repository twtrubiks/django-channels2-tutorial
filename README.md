# django-channels2-tutorial

 django-channels2-tutorial ğŸ’¬

* [Youtube Tutorial Part1 - django channels2 demo ä»¥åŠç°¡ä»‹](https://youtu.be/jIMtZkfs8yY)

* [Youtube Tutorial Part2 - django channels2 tutorial](https://youtu.be/_4Q801WL8sA)

## å‰è¨€

æœ€è¿‘å‰›å¥½æƒ³ç©ä¸€ä¸‹èŠå¤©å®¤ï¼Œæ–¼æ˜¯å°±æ‰¾åˆ° [Channels](https://github.com/django/channels)ï¼Œä¹Ÿå¾ [releases](https://github.com/django/channels/releases) é€™è£¡ç™¼ç¾åœ¨ä»Šå¹´ 2 æœˆçš„æ™‚å€™ **Channels 2**

è¢« releases å‡ºä¾†ï¼Œæ‰€ä»¥æ±ºå®šç°¡å–®æ•´ç†ä¸€ç¯‡ä»‹ç´¹çµ¦å¤§å®¶ã€‚

é€é Django [Channels](https://github.com/django/channels) å»ºç«‹ç°¡å–®çš„èŠå¤©å®¤ç¯„ä¾‹ï¼Œæ­¤ç¯„ä¾‹ç‚ºå®˜æ–¹çš„ [Tutorial](https://channels.readthedocs.io/en/latest/tutorial/index.html)ï¼Œå¸Œæœ›èƒ½é€éé€™å€‹ç°¡å–®çš„ç¯„ä¾‹ï¼Œè®“å¤§

å®¶æ›´äº†è§£ Channelsï¼Œæˆ‘æœ‰ç¨å¾®ä¿®æ”¹ä¸€äº›éƒ¨åˆ†ï¼Œå®˜æ–¹ç¯„ä¾‹æ˜¯ä½¿ç”¨  Channels 2.0 ,  Python 3.5+ , Django 1.11ï¼Œ

æˆ‘é€™é‚Šæœ€ä¸»è¦çš„æ˜¯å°‡ä»–ä¿®æ”¹ç‚º Django 2.0ã€‚

æ³¨æ„ï¼ŒChannels 1 å’Œ Channels 2 æœ‰è »å¤§çš„å·®ç•°ï¼Œé€™é‚Šéƒ½æ˜¯è¬› Channels 2ï¼Œè©³ç´°å¯åƒè€ƒ [Whatâ€™s new in Channels 2?](https://channels.readthedocs.io/en/latest/one-to-two.html)

ä¹‹å‰ï¼Œæˆ‘ä¹Ÿæœ‰ä½¿ç”¨é flask å¯«éèŠå¤©å®¤ï¼Œå¯åƒè€ƒ [chat-room](https://github.com/twtrubiks/chat-room)ã€‚

è®“æˆ‘å€‘å…ˆä¾†çœ‹çœ‹åŸ·è¡Œçš„ç•«é¢å§:laughing:

## åŸ·è¡Œç•«é¢

è¼¸å…¥ä¸€å€‹åç¨±å»ºç«‹èŠå¤©å®¤ç¾¤çµ„ï¼Œç›´æ¥ç€è¦½ [http://localhost:8000/chat/](http://localhost:8000/chat/)

![alt tag](https://i.imgur.com/WSZEJNU.png)

æ¥è‘—å¯ä»¥åœ¨èŠå¤©å®¤è£¡é¢æ‰“å­—

![alt tag](https://i.imgur.com/sraj4Ls.png)

åŒä¸€å€‹èŠå¤©å®¤ç¾¤çµ„æœƒäº’ç›¸æ”¶åˆ°è¨Šæ¯ï¼Œä¸åŒçš„èŠå¤©å®¤ç¾¤çµ„è¨Šæ¯ **ä¸æœƒäº’é€š**ï¼Œ

![alt tag](https://i.imgur.com/JDD0JYb.png)

æˆ‘çŸ¥é“é€™å€‹èŠå¤©å®¤çœŸçš„éå¸¸çš„é†œ:joy:ï¼Œè€Œä¸”ä¹Ÿæ²’æ­é… databaseï¼Œä½†é€™ç¯‡åªæ˜¯ä¸€å€‹è¦è®“å¤§å®¶äº†è§£ Channels

å¦‚ä½•å»ºç«‹ä¸€å€‹èŠå¤©å®¤ï¼Œä¸‹ä¸€ç¯‡æ–‡ç« ï¼Œæˆ‘æœƒä¾ç…§é€™ç¯‡ç‚ºé››å½¢ï¼Œå»ºç«‹ä¸€å€‹æœ‰ç°¡å–®çš„ç™»å…¥è¨»å†Šç³»çµ±ä»¥åŠç¾åŒ–éçš„

èŠå¤©å®¤çµ¦å„ä½ï¼Œå¦‚æœå¤§å®¶ç­‰ä¸åŠæƒ³å…ˆæ¶å…ˆçœ‹ï¼Œå¯ç€è¦½ [django-chat-room](https://github.com/twtrubiks/django-chat-room)ã€‚

ä½†å»ºè­°é€™ç¯‡æ–‡ç« é‚„æ˜¯è¦çœ‹ï¼Œå› ç‚ºæˆ‘å°‡ä»‹ç´¹ä¸€äº›åŸºæœ¬çš„æ¦‚å¿µä»¥åŠäº’å‹•çš„æµç¨‹ã€‚

## å¦‚ä½•åŸ·è¡Œ

ç¢ºèªé›»è…¦æœ‰å®‰è£ docker å¾Œï¼Œç›´æ¥åŸ·è¡Œä»¥ä¸‹æŒ‡ä»¤å³å¯ï¼Œ

```cmd
docker-compose up
```

![alt tag](https://i.imgur.com/jTFNXoH.png)

å¦‚ä½•ç§»é™¤ ( åŒ…å«ç§»é™¤ volume )ï¼Œ

```cmd
docker-compose down -v
```

## ç°¡ä»‹

é€™é‚Šå…ˆä»‹ç´¹å¹¾å€‹åè©ï¼Œæˆ‘ä¸æœƒè¬›çš„éå¸¸è©³ç´°ï¼Œå› ç‚ºå¤§å®¶å¯ä»¥ç”¨é—œéµå­—å» google ï¼Œå¾ˆå¤šæ–‡ç« éƒ½è§£é‡‹éå¸¸æ¸…æ¥šäº†:grin:

### WebSocket

WebSocket æ˜¯ä¸€ç¨®å–®ä¸€ TCP é€£ç·šä¸Šé€²è¡Œå…¨é›™å·¥ï¼ˆfull-duplexï¼‰é€šè¨Šç®¡é“ï¼Œå¯ä»¥è®“ç¶²é èˆ‡ä¼ºæœå™¨ä¹‹é–“åšå³æ™‚æ€§ã€

é›™å‘çš„è³‡æ–™å‚³éã€‚

Websocket éœ€è¦å…ˆå»ºç«‹é€£ç·šï¼Œéœ€è¦é€šéç€è¦½å™¨ç™¼å‡ºè«‹æ±‚ï¼Œä¹‹å¾Œä¼ºæœå™¨é€²è¡Œå›æ‡‰ï¼Œé€™æ®µéç¨‹ç¨±ç‚º **äº¤æ¡**ï¼ˆ handshaking ï¼‰ã€‚

å»¶ä¼¸é–±è®€ï¼Œå¦‚æœå¤§å®¶æœ‰èˆˆè¶£ï¼Œå¯ä»¥å†å»çœ‹çœ‹ polling ( è¼ªè©¢ ) çš„æ¦‚å¿µã€‚

### Channels

æœ¬æ¬¡çš„ä¸»è§’ï¼Œä½ å¯ä»¥æŠŠ Django æƒ³æˆæ˜¯ synchronous ( åŒæ­¥ )ï¼Œè€Œé€é Channelsï¼Œå¯ä»¥æ”¹è®Š

Django synchronousï¼ˆ åŒæ­¥ï¼‰çš„æ ¸å¿ƒè½‰è®Šç‚º asynchronousï¼ˆéåŒæ­¥ï¼‰çš„ç¨‹å¼ç¢¼ã€‚

ä»¥ä¸‹æ“·å–å®˜æ–¹æ–‡ä»¶

channels allowing Django projects to handle not only HTTP, but protocols that require long-running connections too WebSockets, MQTT, chatbots, amateur radio, and more.

it provides integrations with Djangoâ€™s auth system, session system, and more, making it easier than ever to extend your HTTP-only project to other protocols.

channels æ”¯æŒå¾ˆå¤šå”å®šï¼Œè€Œä¸”ä¹Ÿæ•´åˆäº† Django çš„ auth ä»¥åŠ session ç³»çµ±ç­‰ç­‰ã€‚

### ASGI

ASGI å…¨åç‚º Asynchronous Server Gateway Interfaceï¼Œ

ä»–æ˜¯ WSGI çš„ç²¾ç¥ç¹¼æ‰¿è€…ï¼Œä¸åªæ˜¯ä½¿ç”¨ `asyncio` ç•°æ­¥çš„æ–¹æ³•é‹è¡Œï¼Œè€Œä¸”ä¹Ÿæ”¯æ´å¤šç¨®å”å®šã€‚

æ›´å¤šèªªæ˜å¯åƒè€ƒ [ASGI](https://channels.readthedocs.io/en/stable/asgi.html)ã€‚

## æ•™å­¸

æˆ‘å°‡ç°¡å–®èªªæ˜é€™å€‹ç¯„ä¾‹çš„æµç¨‹ï¼Œä½†è©³ç´°çš„ä»‹ç´¹ï¼Œæˆ‘é‚„æ˜¯éå¸¸å»ºè­°å¤§å®¶è§€çœ‹å®˜æ–¹çš„ [Tutorial](https://channels.readthedocs.io/en/latest/tutorial/index.html) ç¯„ä¾‹ã€‚

### å»ºç«‹ç’°å¢ƒ

é€™éƒ¨ä»½åªæ˜¯å’Œå¤§å®¶èªªæ˜åŸºæœ¬çš„ç’°å¢ƒè¨­å®šï¼Œå…¶å¯¦ç›´æ¥ `docker-compose up` å³å¯ï¼Œå› ç‚ºæˆ‘éƒ½å¹«å¤§å®¶åŒ…æˆ docker äº†ï¼Œ

è§£æ±ºäº†ç’°å¢ƒçš„å•é¡Œï¼ˆ åƒæˆ‘åœ¨ windows ä¸Š `channels` ä¸€ç›´è£ä¸èµ·ä¾† :expressionless:ï¼‰ã€‚

é¦–å…ˆï¼Œ æˆ‘ä½¿ç”¨çš„ Python ç‰ˆæœ¬ç‚º 3.6.4ï¼Œ

å®‰è£å¥—ä»¶

```cmd
pip install -r requirements.txt
```

[requirements.txt](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/requirements.txt)

```txt
Django==2.0.4
channels==2.0.2
channels_redis==2.1.1
```

ä½¿ç”¨ Django 2.0.4 ä»¥åŠ channels 2.0.2ï¼Œchannels_redis 2.1.1 ç‚º `CHANNEL_LAYERS` ä¸­çš„ `BACKEND` éœ€è¦ä½¿ç”¨åˆ°çš„ã€‚

### ç”¨ docker å»ºç«‹ redis

é€™éƒ¨ä»½åªæ˜¯å’Œå¤§å®¶èªªæ˜åŸºæœ¬çš„ç’°å¢ƒè¨­å®šï¼Œå…¶å¯¦ç›´æ¥ `docker-compose up` å³å¯ï¼Œå› ç‚ºæˆ‘éƒ½å¹«å¤§å®¶åŒ…æˆ docker äº†ï¼Œ

è§£æ±ºäº†ç’°å¢ƒçš„å•é¡Œï¼ˆ åƒæˆ‘åœ¨ windows ä¸Š `channels` ä¸€ç›´è£ä¸èµ·ä¾† :expressionless:ï¼‰ã€‚

å› ç‚ºé€™é‚Šæœƒä½¿ç”¨åˆ° redisï¼Œæ‰€ä»¥ä½¿ç”¨ docker å»ºç«‹ redisï¼Œå¦‚æœä¸äº†è§£ docker ä»¥åŠ redis ï¼Œ

å¯åƒè€ƒä¸‹é¢é€™å…©ç¯‡æ–‡ç« ï¼Œåˆ†åˆ¥ä»‹ç´¹äº† docker ä»¥åŠ redis

* [Docker åŸºæœ¬æ•™å­¸ - å¾ç„¡åˆ°æœ‰ Docker-Beginners-Guide](https://github.com/twtrubiks/docker-tutorial)

* [django-docker-redis-tutorial åŸºæœ¬æ•™å­¸](https://github.com/twtrubiks/django-docker-redis-tutorial)

å»ºç«‹ redis æŒ‡ä»¤ï¼Œ

```cmd
docker run --name some-redis  -p 6379:6379  -d redis redis-server --appendonly yes
```

### channels installation

æ¥ä¸‹ä¾†å°‡ä»‹ç´¹ channels çš„è¨­å®šï¼Œå®˜æ–¹æ–‡ä»¶å¯åƒè€ƒ [installation](https://channels.readthedocs.io/en/latest/installation.html)ï¼Œ

å°‡ channels åŠ å…¥ INSTALLED_APPSï¼Œ

django_channels2_tutorial/[settings.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/django_channels2_tutorial/settings.py)

```python
INSTALLED_APPS = [
    ....
    'django.contrib.messages',
    'django.contrib.staticfiles',
    'channels',
    'chat',
]
```

æº«é¦¨å°æé†’:heart:

`channels` å®˜æ–¹ç¯„ä¾‹æœƒå°‡ä»–æ”¾åœ¨æœ€å‰é¢çš„åŸå› æ˜¯ï¼Œæœ‰äº›å¥—ä»¶æœƒè¡çªï¼Œæ‰€ä»¥å°‡ä»–æ”¾åˆ°ç¬¬ä¸€é †ä½é€™æ¨£ã€‚

chat æ˜¯æˆ‘å€‘å»ºç«‹çš„ï¼ˆ å¾Œé¢æœƒä»‹ç´¹ ï¼‰ï¼Œ

æ¥è‘—å»ºç«‹ default routingï¼Œ

django_channels2_tutorial/[routing.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/django_channels2_tutorial/routing.py)

```python
from channels.auth import AuthMiddlewareStack
from channels.routing import ProtocolTypeRouter, URLRouter

import chat.routing

application = ProtocolTypeRouter({
    # Empty for now (http->django views is added by default)
    'websocket': AuthMiddlewareStack(
        URLRouter(
            chat.routing.websocket_urlpatterns
        )
    ),
})
```

`chat.routing` ä»¥åŠ `chat.routing.websocket_urlpatterns` æ˜¯æˆ‘å€‘è‡ªå·±å»ºç«‹çš„ï¼ˆ å¾Œé¢æœƒä»‹ç´¹ ï¼‰ï¼Œ

è¨­å®š channel settingsï¼Œ

django_channels2_tutorial/[settings.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/django_channels2_tutorial/settings.py)

```python
ASGI_APPLICATION = "django_channels2_tutorial.routing.application"
CHANNEL_LAYERS = {
    'default': {
        'BACKEND': 'channels_redis.core.RedisChannelLayer',
        'CONFIG': {
            'hosts': [('redis', 6379)],
        },
    }
}
```

`ASGI_APPLICATION` è¨­å®šç‚ºè‡ªå·±çš„ project åç¨± ( é€™è£¡æˆ‘å€‘å‘½åç‚º `django_channels2_tutorial` )ï¼Œ

æŒ‡å‘åº•ä¸‹çš„ routingï¼ˆ æˆ‘å€‘å‰›å‰›å»ºç«‹çš„ ï¼‰è£¡çš„ applicationï¼ˆ å‰›å‰›å»ºç«‹çš„ ï¼‰ï¼Œæ‰€ä»¥å®Œæ•´åç¨±ç‚º

`django_channels2_tutorial.routing.application`ã€‚

`CHANNEL_LAYERS` ä¸­çš„ `BACKEND` è¨­å®šç‚º redis ï¼Œä¹Ÿå°±æ˜¯ç‚ºä»€éº¼æˆ‘å€‘å‰é¢è¦å®‰è£ `channels_redis` çš„åŸå› ï¼Œ

`CONFIG` å°±æ˜¯è¨­å®šé€£ç·š redis å­—ä¸²ï¼Œæ˜¯ä¸æ˜¯å¾ˆå¥½å¥‡ç‚ºä»€éº¼ `host` çš„éƒ¨ä»½æˆ‘ç›´æ¥å¯« `redis`ï¼Ÿ

( å…¶å¯¦å°±æ˜¯ [docker-compose.yml](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/docker-compose.yml) ä¸­çš„ redis åç¨± )ã€‚

å¦‚æœå¤§å®¶é‚„æ˜¯ä¸äº†è§£ï¼Œå»ºè­°å¯ä»¥é–±è®€ [é€™ç¯‡](https://github.com/twtrubiks/docker-tutorial#user-defined-networks) çš„èªªæ˜ã€‚

### èªªæ˜

å‰›å‰›ä¸Šé¢æåˆ°äº† [chat](https://github.com/twtrubiks/django-channels2-tutorial/tree/master/chat) è³‡æ–™å¤¾ï¼Œæ¥ä¸‹ä¾†è®“æˆ‘å€‘ä¾†çœ‹çœ‹ [chat](https://github.com/twtrubiks/django-channels2-tutorial/tree/master/chat) åšäº†ä»€éº¼äº‹æƒ…ï¼Œ

chat/[views.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/chat/views.py)

```python
import json

from django.shortcuts import render
from django.utils.safestring import mark_safe

def index(request):
    return render(request, 'chat/index.html', {})


def room(request, room_name):
    return render(request, 'chat/room.html', {
        'room_name_json': mark_safe(json.dumps(room_name))
    })
```

chat/[urls.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/chat/urls.py)

```python
# chat/urls.py
from django.urls import path

from . import views

urlpatterns = [
    path('', views.index, name='index'),
    path('<str:room_name>/', views.room, name='room'),
]
```

é€™é‚Šå¾ˆç°¡å–®ï¼Œå°±æ˜¯å®šç¾©å¥½ views ä»¥åŠ url è€Œå·²ï¼Œæ¯”è¼ƒéœ€è¦æ³¨æ„çš„æ˜¯ url çš„éƒ¨ä»½ï¼Œ

å› ç‚ºæˆ‘å€‘ä½¿ç”¨çš„æ˜¯ `django 2.0`ï¼Œæ‰€ä»¥å·²ç¶“æ”¹ç”¨ `path` äº†ï¼Œå…¶å¯¦ç¸½é«”ä¾†èªªï¼Œæˆ‘

è¦ºå¾—`django 2.0` åœ¨è™•ç† url ä¸Šæ›´æ–¹ä¾¿äº†ï¼Œä»¥å‰è¦å¯«æ­£å‰‡è¡¨é”å¼:scream:ã€‚

æˆ‘å€‘ä¾†çœ‹ä¸€ä¸‹æ¯”è¼ƒé‡è¦çš„ consumersï¼Œ

è©³ç´°çš„ä»‹ç´¹ï¼Œå¯åƒè€ƒå®˜ç¶²èªªæ˜ [consumers](https://channels.readthedocs.io/en/stable/topics/consumers.html)ï¼Œ

é€™è£¡å…ˆçµ¦å¤§å®¶ç°¡å–®çš„è§€å¿µï¼Œconsumers æ˜¯åœ¨ Channels ä¸­çš„ä¸€å€‹åŸºæœ¬å–®ä½ï¼Œç•¶ä¸€å€‹ request æˆ– socket é€²ä¾†æ™‚ï¼Œ

Channels æœƒå»æ‰¾ä»–çš„ routing tableï¼Œæ‰¾åˆ°å°çš„ consumersï¼ŒåŸºæœ¬ä¸Šï¼Œconsumers å°±åƒæ˜¯ Django ä¸­çš„ viewsã€‚

consumers æœ‰å…©å€‹é»è¦å’Œå¤§å®¶æä¸€ä¸‹ï¼ˆ æ“·å–å®˜æ–¹èªªæ˜ ï¼‰ï¼Œ

* Structures your code as a series of functions to be called whenever an event happens, rather than making you write an event loop.

* Allow you to write synchronous or async code and deals with handoffs and threading for you.

å…ˆä¾†çœ‹ chat/[routing.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/chat/routing.py)ï¼Œ

```python
from django.urls import path

from . import consumers

websocket_urlpatterns = [
    path('ws/chat/<str:room_name>/', consumers.ChatConsumer),
]
```

å®šç¾©äº† websocket_urlpatternsï¼Œä¸¦ä¸”è¨­å®š `ChatConsumer` classï¼Œ

é‚£æˆ‘å€‘åœ¨å“ªé‚Šå®šç¾©é€™å€‹ routing å‘¢ ï¼Ÿ

django_channels2_tutorial/[routing.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/django_channels2_tutorial/routing.py)

```python
from channels.auth import AuthMiddlewareStack
from channels.routing import ProtocolTypeRouter, URLRouter

import chat.routing

application = ProtocolTypeRouter({
    # Empty for now (http->django views is added by default)
    'websocket': AuthMiddlewareStack(
        URLRouter(
            chat.routing.websocket_urlpatterns
        )
    ),
})
```

root routing è¨­å®šçš„åœ°æ–¹å°±æ˜¯åœ¨å‰é¢ä»‹ç´¹çš„ django_channels2_tutorial/[routing.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/django_channels2_tutorial/routing.py)ï¼Œ

ä¹Ÿå°±æ˜¯ä¸Šé¢çš„ `chat.routing.websocket_urlpatterns`ã€‚

æ¥ä¸‹ä¾†çœ‹ chat/[consumers.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/chat/consumers.py)ï¼Œ

```python
import json

from asgiref.sync import async_to_sync
from channels.generic.websocket import WebsocketConsumer


class ChatConsumer(WebsocketConsumer):
    def connect(self):
        self.room_name = self.scope['url_route']['kwargs']['room_name']
        self.room_group_name = 'chat_%s' % self.room_name

        # Join room group
        async_to_sync(self.channel_layer.group_add)(
            self.room_group_name,
            self.channel_name
        )

        self.accept()

    def disconnect(self, close_code):
        # Leave room group
        async_to_sync(self.channel_layer.group_discard)(
            self.room_group_name,
            self.channel_name
        )

    # Receive message from WebSocket
    def receive(self, text_data):
        text_data_json = json.loads(text_data)
        message = text_data_json['message']

        # Send message to room group
        async_to_sync(self.channel_layer.group_send)(
            self.room_group_name,
            {
                'type': 'chat_message',
                'message': message
            }
        )

    # Receive message from room group
    def chat_message(self, event):
        message = event['message']

        # Send message to WebSocket
        self.send(text_data=json.dumps({
            'message': message
        }))
```

ä»¥ä¸Šæ˜¯ä½¿ç”¨ synchronousï¼ˆ åŒæ­¥ ï¼‰çš„æ–¹æ³•ã€‚

æ¥è‘—å°‡ä»‹ç´¹ä»–å€‘äº’å‹•çš„æµç¨‹ï¼ˆ äº‹ä»¶å¦‚ä½•è§¸ç™¼ ï¼‰ï¼Œ

`connect`

ç•¶å‰ç«¯ç™¼ Websocket éä¾†çš„æ™‚å€™æœƒè§¸ç™¼æ­¤äº‹ä»¶ï¼Œ

é‚£å‰ç«¯å“ªæ™‚å€™æœƒé€è¨Šæ¯éä¾†å‘¢ ï¼Ÿ

æˆ‘å€‘ä¾†çœ‹ chat/templates/chat/[room.html](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/chat/templates/chat/room.html)ï¼Œ

```javascript
...
<script>
    var roomName = {{ room_name_json }};

    var chatSocket = new WebSocket(
        'ws://' + window.location.host + '/ws/chat/' + roomName + '/');
    ...
</script>
```

ç•¶å‰ç«¯ WebSocket åˆå§‹è©±é€£ç·šçš„æ™‚å€™ï¼Œæœƒè§¸ç™¼ `connect`ã€‚

æ¥ä¸‹ä¾†èªªæ˜ `connect` ä¸­çš„ä¸€äº›æ–¹æ³•ï¼Œ

é¦–å…ˆæ˜¯ `self.scope` é€™å€‹ï¼Œä½ å¯ä»¥æŠŠå®ƒæƒ³æˆåƒæ˜¯ Django è£¡çš„ `self.request`ï¼Œ

è€Œ `url_route` å‰‡æ˜¯æŠ“å– urlï¼Œæˆ‘å€‘å–å‡º `room_name` ï¼Œç‚ºä»€éº¼æ˜¯ `room_name` ï¼Œ

åŸå› æ˜¯æˆ‘å€‘åœ¨ chat/[urls.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/chat/urls.py) ä¸­è¨­å®š `urlpatterns` è®Šæ•¸ç‚º  `room_name`ï¼Œ

chat/[urls.py](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/chat/urls.py)

```python
from django.urls import path

from . import views

urlpatterns = [
    path('', views.index, name='index'),
    path('<str:room_name>/', views.room, name='room'),
]
```

æ¥ä¸‹ä¾†æˆ‘å€‘é€é `async_to_sync` æŠŠ channel åŠ å…¥ group ä¸­ï¼Œchannel å’Œ group çš„é—œä¿‚ä¹Ÿä¸ç”¨æƒ³çš„å¤ªè¤‡é›œï¼Œ

å…¶å¯¦ä»–å€‘çš„é—œä¿‚å°±æ˜¯ä¸€å€‹ group ä¸­ï¼Œå¯ä»¥æœ‰å¾ˆå¤šå€‹ channel é€™æ¨£ã€‚

æœ€å¾Œæ˜¯ `self.accept()` é€™å€‹ï¼Œå°±æ˜¯æ¥å—é€™å€‹é€£ç·šï¼Œå¦‚æœè¦æ‹’çµ•é€™æ¬¡çš„é€£ç·šï¼Œä½¿ç”¨ `self.close()` å³å¯ã€‚

`disconnect`

å°‡ channel å¾ group ä¸­ç§»é™¤ï¼Œ

æˆ‘å€‘ä¾†çœ‹ chat/templates/chat/[room.html](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/chat/templates/chat/room.html)

```javascript
...
<script>
    ....
    chatSocket.onclose = function(e) {
        console.error('Chat socket closed unexpectedly');
    };
    ....
</script>
```

ç•¶ server ç«¯çš„ WebSocket é—œé–‰æ™‚ï¼Œå‰ç«¯çš„ `chatSocket.onclose` æœƒè¢«è§¸ç™¼ã€‚

`receive`

ç•¶æˆ‘å€‘æ”¶åˆ°ä¾†è‡³å‰ç«¯çš„ WebSocket è¨Šæ¯æ™‚ï¼Œ

é‚£å‰ç«¯å“ªæ™‚å€™æœƒé€è¨Šæ¯éä¾†å‘¢ ï¼Ÿ

æˆ‘å€‘ä¾†çœ‹ chat/templates/chat/[room.html](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/chat/templates/chat/room.html)

```javascript
...
<script>
    ....
    document.querySelector('#chat-message-submit').onclick = function(e) {
        var messageInputDom = document.querySelector('#chat-message-input');
        var message = messageInputDom.value;
        chatSocket.send(JSON.stringify({
            'message': message
        }));

        messageInputDom.value = '';
    };
</script>
```

`chatSocket.send` å°±æœƒè§¸ç™¼é€™å€‹äº‹ä»¶ï¼Œ`receive` å°‡æ”¶åˆ°çš„ message é€åˆ°å°æ‡‰çš„
group ä¸­ï¼Œ

`type` å°±æ˜¯æŒ‡ `chat_message`ã€‚

`chat_message`

ç•¶å¾ group ä¸­æ”¶åˆ° message æ™‚ï¼Œæœƒè§¸ç™¼é€™å€‹äº‹ä»¶ï¼Œæˆ‘å€‘å°‡æ”¶åˆ°çš„ message é€å›å‰ç«¯çš„ WebSocketï¼Œ

é‚£å‰ç«¯èª°æ¥æ”¶çš„ï¼Ÿ

æˆ‘å€‘ä¾†çœ‹ chat/templates/chat/[room.html](https://github.com/twtrubiks/django-channels2-tutorial/blob/master/chat/templates/chat/room.html)

```javascript
...
<script>
    ....
    chatSocket.onmessage = function(e) {
        var data = JSON.parse(e.data);
        var message = data['message'];
        document.querySelector('#chat-log').value += (message + '\n');
    };
    ....
</script>
```

`chatSocket.onmessage` æœƒæ”¶åˆ°è¨Šæ¯ï¼Œå‰ç«¯å†å°‡è¨Šæ¯å¢åŠ åˆ°ç•«é¢ä¸Šã€‚

ä»¥ä¸Šï¼Œå°±æ˜¯æ•´å€‹å‰å¾Œç«¯ WebSocket äº‹ä»¶äº’å‹•çš„æµç¨‹ã€‚

### Rewrite Chat Server as Asynchronous

å®˜ç¶²å¯åƒè€ƒ [Tutorial Part 3](https://channels.readthedocs.io/en/latest/tutorial/part_3.html)ï¼Œ

å‰›å‰›æ˜¯ä½¿ç”¨ synchronousï¼ˆ åŒæ­¥ ï¼‰çš„æ–¹æ³•ï¼Œç¾åœ¨æˆ‘å€‘è¦æ”¹å¯«ä»–ç‚º asynchronousï¼ˆ éåŒæ­¥ï¼‰çš„æ–¹æ³•ï¼Œ

```python
import json
from channels.generic.websocket import AsyncWebsocketConsumer


class ChatConsumer(AsyncWebsocketConsumer):
    async def connect(self):
        self.room_name = self.scope['url_route']['kwargs']['room_name']
        self.room_group_name = 'chat_%s' % self.room_name

        # Join room group
        await self.channel_layer.group_add(
            self.room_group_name,
            self.channel_name
        )

        await self.accept()

    async def disconnect(self, close_code):
        # Leave room group
        await self.channel_layer.group_discard(
            self.room_group_name,
            self.channel_name
        )

    # Receive message from WebSocket
    async def receive(self, text_data):
        text_data_json = json.loads(text_data)
        message = text_data_json['message']

        # Send message to room group
        await self.channel_layer.group_send(
            self.room_group_name,
            {
                'type': 'chat_message',
                'message': message
            }
        )

    # Receive message from room group
    async def chat_message(self, event):
        message = event['message']

        # Send message to WebSocket
        await self.send(text_data=json.dumps({
            'message': message
        }))

```

å®˜ç¶²çš„æœ€å¾Œä¸€éƒ¨åˆ†æ˜¯ [Automated Testing](https://channels.readthedocs.io/en/latest/tutorial/part_4.html)ï¼Œé€™éƒ¨ä»½æˆ‘å°±æ²’æœ‰å¯«äº†ï¼Œå¦‚æœå„ä½æœ‰èˆˆè¶£ï¼Œå°±è«‹å†è‡ªè¡Œå‰å¾€é–±è®€ã€‚

## å¾Œè¨˜

é€™æ¬¡å’Œå¤§å®¶è§£é‡‹äº†åˆ©ç”¨ channels å»ºç«‹å‡ºçš„ç°¡æ˜“ç‰ˆ chat roomï¼Œä¹Ÿèªªæ˜äº†ä»–å€‘äº’å‹•çš„æ–¹å¼ä»¥åŠéç¨‹ï¼Œ

å¸Œæœ›å¯ä»¥å° channels æœ‰åŸºç¤çš„èªè­˜ï¼Œå¦‚æœæ„çŒ¶æœªç›¡ï¼Œå¯ä»¥åƒè€ƒä¸‹ä¸€ç¯‡çµåˆ database ä»¥åŠç¾åŒ–çš„èŠå¤©

å®¤ï¼ŒåŸºæœ¬ä¸Šæ˜¯ç”¨é€™ç¯‡çš„æ•™å­¸å»¶ä¼¸å‡ºå»çš„ï¼Œå¯åƒè€ƒ [django-chat-room](https://github.com/twtrubiks/django-chat-room) ã€‚

## åŸ·è¡Œç’°å¢ƒ

* Python 3.6.4

## Reference

* [Django](https://www.djangoproject.com/)
* [Channels](https://github.com/django/channels)

## Donation

æ–‡ç« éƒ½æ˜¯æˆ‘è‡ªå·±ç ”ç©¶å…§åŒ–å¾ŒåŸå‰µï¼Œå¦‚æœæœ‰å¹«åŠ©åˆ°æ‚¨ï¼Œä¹Ÿæƒ³é¼“å‹µæˆ‘çš„è©±ï¼Œæ­¡è¿è«‹æˆ‘å–ä¸€æ¯å’–å•¡:laughing:

![alt tag](https://i.imgur.com/LRct9xa.png)

[è´ŠåŠ©è€…ä»˜æ¬¾](https://payment.opay.tw/Broadcaster/Donate/9E47FDEF85ABE383A0F5FC6A218606F8)

## License

MIT licens
